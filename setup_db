-- Persistent log tracking table for Nitrado monitoring
CREATE TABLE IF NOT EXISTS nitrado_log_state (
  guild_id VARCHAR(50) NOT NULL,
  service_id VARCHAR(50) NOT NULL,
  file_name TEXT NOT NULL,
  last_position BIGINT DEFAULT 0,
  last_timestamp BIGINT DEFAULT 0,
  updated_at TIMESTAMP DEFAULT NOW(),
  PRIMARY KEY (guild_id, service_id, file_name)
);
CREATE TABLE IF NOT EXISTS guild_feed_map (
  guild_id VARCHAR(50) PRIMARY KEY,
  feed_map JSONB NOT NULL,
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS nitrado_creds (
    discord_id VARCHAR(20) PRIMARY KEY,
    encrypted_token TEXT NOT NULL,
    service_id VARCHAR(50) NOT NULL,
    updated_at TIMESTAMP DEFAULT NOW()
);
-- =======================================
-- NITRADO TOKENS TABLE
-- =======================================
CREATE TABLE IF NOT EXISTS nitrado_tokens (
  id SERIAL PRIMARY KEY,
  guild_id TEXT NOT NULL,
  discord_user_id TEXT NOT NULL,
  service_id TEXT NOT NULL,
  access_token TEXT NOT NULL,
  refresh_token TEXT,
  expires_at TIMESTAMP,
  permission_level SMALLINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE UNIQUE INDEX IF NOT EXISTS nitrado_guild_service_idx
  ON nitrado_tokens (guild_id, service_id);

